---
published: false
title: Lecture 8. Spatial Localization and Detection
category: [CS231n]
use_math: true
---

> 해당 포스트는 송경석 교수님의 유튜브 강의를 정리한 내용입니다. 강의 영상은 [여기](https://youtube.com/playlist?list=PL1Kb3QTCLIVtyOuMgyVgT-OeW0PYXl3j5)에서 보실 수 있습니다.

## Localization and Detection

![p7](/images/cs231n/slides/lecture8/winter1516_lecture8-07.png)

이번 포스트에서 살펴볼 것은 Localization 과 Detection 입니다.

### Computer Vision Tasks

![p7](/images/cs231n/slides/lecture8/winter1516_lecture8-08.png)

우선, 유사한 개념들의 차이점을 정리해보고 들어가도록 하겠습니다.

Classification 은 이미지가 들어오면 이 이미지가 어떠한 이미지인지, 예를 들어 위의 그림과 같이 CAT 이라고 labeling 해주는 것 입니다.

Classification + Localization 은 분류와 함께, Localization 을 진행하는 것인데, CAT 이 이미지의 어디에 위치해 있는지를 Boxing 해주는 것을 localization 이라고 합니다.

다음으로, Detection 이라는 것은 하나의 object 를 boxing 해주는 localization 과는 다르게 여러개의 Object 들을 모두 찾아내는 것을 Object Detection 이 되겠습니다.

마지막으로 Segmentation 은 위 그림과 같이 고양이, 오리, 개를 형상대로 테두리를 따 주는 것을 말합니다.

그래서 이번 포스트에서는 Localization 과 Detection 에 대해 다뤄보고, Segmentation 은 후에 Lecture 13 에서 다뤄보도록 하겠습니다.

## Localization 

![p7](/images/cs231n/slides/lecture8/winter1516_lecture8-10.png)

Classification 은 C 클래스가 있을 떄 input 으로 이미지를 받아서 output 으로 Class label 을 줍니다. 그리고 이를 평가하는 지표는 Accuracy(정확도)가 됩니다. 위 그림에서 처럼 이미지가 들어왔을 떄 고양이다 라고 분류를 하는 식으로 동작합니다.

Localization 은 이미지가 들어오면 결과로 Label 이 아닌 Box를 리턴합니다. 예를 들어 left top 에서 시작하는 (x, y) 좌표와 width, height 를 주게 되는 것 입니다. 그리고 평가 지표는 IoU(Intersaction over Union). 즉, 겹치는 부분이 몇 퍼센트인지 가 됩니다.

그리고 Classification 과 Localization 을 같이 진행하게 되면, Label 과 (x, y, w, h) 를 같이 얻게 되는 것 입니다.

![p7](/images/cs231n/slides/lecture8/winter1516_lecture8-11.png)

이전 포스트들에서 계속 언급했던 ImageNet 에는 Classification 대회만 있는 것이 아니라 여러가지 대회가 있는데, 그 중 하나가 Classification 과 Localization 을 결합한 것이 되겠습니다.

여기서도 마찬가지로 1,000 개의 Class 들이 있고, 각 이미지들에는 1개의 Class 와 최소 1개의 bounding box 가 있습니다. 그리고 Classification 에서 와 같이 top 5 error 를 계산했던 것 처럼, 5개의 후보를 추출하여 최소한 1개의 Class 를 맞추고, IoU 가 0.5 이상이 되면 맞춘걸로 간주합다고 합니다.

### Idea 1. Localization as Regression

![p7](/images/cs231n/slides/lecture8/winter1516_lecture8-12.png)

Localization 을 하는 방법에는 크게 2가지가 있습니다. 그 중 첫 번째 방법은 Localization as Regression 입니다. 즉, Localization 을 Regression 이라고 간주하는 것인데, 이 방법은 나름 매우 강력합니다.

1개를 localize 하거나 $k$ 개를 localize 할 때, Image Detection 을 고집하지 않고 이 방법을 사용해도 된다는 의미입니다.

방법은 다음과 같습니다.

- 이미지를 input 으로 받아 신경망에 넣어줍니다.
- output 으로 4개의 숫자로 구성된 box 의 좌표를 얻습니다.
- 이를 실제 correct box 좌표와 비교를 하여 L2 Distance 를 활용한 Loss 를 구하게 됩니다.
- 이렇게 구한 Loss 를 Backpropagation 때 학습하여 최적화합니다.

단계별로 보면 다음과 같습니다.

![p7](/images/cs231n/slides/lecture8/winter1516_lecture8-13.png)

첫 번째 단계에서는 Classification model 을 학습시킵니다.

![p7](/images/cs231n/slides/lecture8/winter1516_lecture8-14.png)

두 번째 단계에서는 지금까지 해왔던 `Classification head` 에 `Regression head` 를 추가 해줍니다.

그래서 `Regression head` 에서는 결과물이 박스의 좌표가 되도록 합니다.

![p7](/images/cs231n/slides/lecture8/winter1516_lecture8-15.png)

세 번째 단계에서는 방금 앞에서 추가했던 `Regression head` 부분만 학습을 진행합니다.

![p7](/images/cs231n/slides/lecture8/winter1516_lecture8-16.png)

그리고 마지막 단계에서는 `Classification head` 와 `Regression head` 모두를 이용해서 결과물을 산출해냅니다.

이처럼 간단하게 구성이 됩니다.

![p7](/images/cs231n/slides/lecture8/winter1516_lecture8-17.png)

그런데, `Regression head` 부분에는 `Per-class` 와 `Class agnostic` 이라는 2 가지 방법이 있습니다. 

쉽게 말하면, `Per-class` 는 어떤 Class 에 특화된, Class Specific 한 방법이고, `Class agnostic` 이라는 것은 각각의 Class 와 무관하게, 범용적인 접근 방법이라고 할 수 있습니다.

`class agnostic` 은 특정 class 에 특화되지 않기 떄문에, 하나의 box 만을 결과물로 도출하게 됩니다. 

반면에, `per-class` 즉, `class specific` 은 각 class 당 하나의 box. 즉, 4개의 숫자가 각 class 별로 결과를 도출하게 됩니다.

이 두가지 방법은 loss 를 계산하는 방법 외에는 별 차이가 없는 굉장히 유사한 방법입니다. 다만, loss 계산에서 `class specific` 한 방법은 Ground-truth 의 좌표만 이용한다는 차이만 있습니다.

![p18](/images/cs231n/slides/lecture8/winter1516_lecture8-18.png)

그렇다면, `Regression head`를 어디에 붙여야하는지에 대해서 보겠습니다.

이것도 두 가지 방법이 있는데, 두 가지 방법 모두 통합니다.

첫 번째로, 마지막 CONV. Layer 뒤에 붙여주는 방법이 있습니다. Overfeat 이나 VGG 같은 경우 이렇게 합니다.

아니면, FC. Layer 뒤에 붙여주는 방법이 있습니다. DeepPose 나 R-CNN 같은 경우가 이런 경우인데, 어떤 경우든 잘 동작합니다.

![p18](/images/cs231n/slides/lecture8/winter1516_lecture8-19.png)

참고로 여러개 Object 의 Localizing 도 잘 동작합니다.

정해진 $K$ 개의 Object 를 찾아내는 것은 Regression 만으로도 잘 동작하기 때문에, 굳이 모든 것을 찾아내야하는 경우가 아니고 정해진 개수만 찾아내면 되는 경우라면 Detection 을 사용하지 않고, Regression 만을 이용해서 쉽게 구현이 가능하다는 것 입니다.

이러한 예로 사람의 자세를 측정하는 것이 있습니다.

![p18](/images/cs231n/slides/lecture8/winter1516_lecture8-20.png)

사람의 관절 수는 정해져 있기 때문에, Regression 을 통해 쉽게 구현이 가능합니다.

![p18](/images/cs231n/slides/lecture8/winter1516_lecture8-21.png)

정리하자면, Regression 을 통해서 Localization 을 하는 것은 매우 Simple 하고, 나름 강력하기 때문에 여러 사례에 충분히 응용하기 쉽습니다. 다만, ImageNet Competition 과 같은데에서 수상이 목적이라면, 좀 더 복잡한 방법을 사용해야 할 것입니다. 바로 다음으로 살펴볼 `sliding window` 가 그것입니다.

### Idea 2. Sliding Window

![p22](/images/cs231n/slides/lecture8/winter1516_lecture8-22.png)

지금부터, Localization 을 하는 두 번째 방법인 `Sliding Window` 에 대해서 알아보겠습니다.

기본적으로 앞의 `Regression` 방법과 동일하게, `Classification head`와 `Regression head` 두 개로 분류해서 진행을 합니다만, 이미지를 한번만 돌리지 않고 이미지 여러 군데를 돌려 합쳐주는 기법입니다.

그리고 또한, 편의성을 위해 FC. Layer 를 CONV. Layer 로 변환해주어 연산을 진행하게 됩니다. 